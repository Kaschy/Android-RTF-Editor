
<template id = "rtftemplate">{\rtf1\ansi\ansicpg1252\deff0\nouicompat{\fonttbl{\f0\fnil\fcharset0 Calibri;}{\f1\fnil\fcharset0 Arial;}{\f2\fnil\fcharset2 Symbol;}}
{\*\generator Riched20 10.0.14393}\viewkind4\uc1
\pard\sa200\sl276\slmult1\f0\fs22\lang7
Hi, this is a  test phrase!\par
\b Hi, this is a  test phrase!\par
\ul Hi, this is a  test phrase!\par
\i Hi, this is a  test phrase!\par
\ulnone\b0\i0\f1\fs20 Hi, this is a  test phrase!\par

\pard{\pntext\f2\'B7\tab}{\*\pn\pnlvlblt\pnf2\pnindent0{\pntxtb\'B7}}\fi-360\li720\sa200\sl276\slmult1 aitem\par

\pard{\pntext\f2\'B7\tab}{\*\pn\pnlvlblt\pnf2\pnindent0{\pntxtb\'B7}}\fi-360\li720\sa200\sl240\slmult1\par

\pard{\pntext\f2\'B7\tab}{\*\pn\pnlvlblt\pnf2\pnindent0{\pntxtb\'B7}}\fi-360\li720\sa200\sl276\slmult1\f0\fs22\par
{\pntext\f2\'B7\tab}\f1\fs20 bitem\f0\fs22\par
{\pntext\f2\'B7\tab}\f1\fs20 citem\f0\fs22\par

\pard
{\pntext\f0 1.\tab}{\*\pn\pnlvlbody\pnf0\pnindent0\pnstart1\pndec{\pntxta.}}
\fi-360\li720\sa200\sl276\slmult1\f1\fs20 aitem\f0\fs22\par
{\pntext\f0 2.\tab}\f1\fs20 bitem\f0\fs22\par
{\pntext\f0 3.\tab}\f1\fs20 citem\f0\fs22\par

\pard\sa200\sl276\slmult1\par
}</template>

<script>


function GroupState(destination){
  var instance = this;
  instance.destination = destination;// The destination, or part of the document that the plain text is constructing.
  instance.characterFormatting = [];// Character-formatting properties, such as bold or italic.
  instance.paragraphFormatting = [];//Paragraph-formatting properties, such as justified or centered.
  instance.sectionFormatting = [];//Section-formatting properties, such as the number of columns.
  instance.tableFormatting = [];// Table-formatting properties, which define the number of cells and dimensions of a table row.
  return instance;
}



function download(filename, text) {
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    pom.setAttribute('download', filename);

    if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
    }
    else {
        pom.click();
    }
}

function downloadRTF(){
  var template = document.getElementById("rtftemplate");
  var content = template.innerHTML;
  download("test.rtf",content);
}
var handlers = [];
handlers['\\b'] = function(){
    return "";
};
handlers['\\b0'] = function(){
    return "";
};
handlers['ul'] = function(){
    return "";
};
handlers['ulnone'] = function(){
    return "";
};
handlers['i'] = function(){
    return "<i>";
};
handlers['i0'] = function(){
    return "</i>";
};
handlers['par'] = function(){
    return "<br>";
};
function istoken(token){
  return token in handlers;
}

function tokenToHtml(token){
  return handlers[token]();
}



function parse(rtftext){
  var html;

  var groupStateStack = [];
  var currentGroupState = null;


  for(var i=0;i<rtftext.length;i++){
    var nextToken;
    var nextTokenEquals = function(str,cb){
      var equals;
      if(str instanceof RegExp){
        var match = str.exec(rtftext.substring(i));
        if (match != null) {
          console.log(match);
            //console.log("match found at " + match.index);
            //console.log(match);
            equals = (match.index == 0);
            if(equals){
              nextToken = match[0];
            }
        }

      }else{
        equals = (rtftext.indexOf(str,i) == i);
        if(equals){
          nextToken = str;
        }
      }
      if(equals){
        i+= nextToken.length;
        console.log(nextToken);
      }

      if(equals && cb){
        cb();
        //carry out action assigned to destination
      }

      return equals;
    }
    function write(str){
        html+=str;
    }



    if(false){}
    else if(nextTokenEquals('\\')){
      if(
        nextTokenEquals('i',function(){
          write("<i>");
        })
        ||nextTokenEquals('i0',function(){
          write("</i>");
        })
        ||nextTokenEquals('ul',function(){
          write("<ul>");
        })
        ||nextTokenEquals('ulnone',function(){
          write("</ul>");
        })
      ){

      }

    }
    else if(nextTokenEquals('{')){

      //section destinationchanges
      if((nextTokenEquals('\\*') || nextTokenEquals('\\')) &&
          nextTokenEquals('footnote')
          ||nextTokenEquals(/.*deff0\\/)
        ||nextTokenEquals('header')
        ||nextTokenEquals('rtf1')
        ||nextTokenEquals('footer')
        ||nextTokenEquals('pict')
        ||nextTokenEquals('info')
        ||nextTokenEquals('fonttbl')
        ||nextTokenEquals('stylesheet')
        ||nextTokenEquals('colortbl')
      )
      {
        groupStateStack.push(currentGroupState);
        currentGroupState = new GroupState(nextToken);
        console.log("push");
      }else{
        //if the first control word is not known skip the whole Group
        //stack braces to remove the right frame
        var depth = 1;
        for(;depth>0;i++){
          if(rtftext[i] == '{'){
            depth++;
          }
          if(rtftext[i] == '}'){
            depth--;
          }
        }




      }
        //endsection destinationchanges
      /*
      If the character is an opening brace (),
      the reader stores its current state on the stack
      */
    }
    else if(nextTokenEquals('}')){
      currentGroupState = groupStateStack.pop();
      console.log("pop");
      /*
       If the character is a closing brace (),
       the reader retrieves the current state from the stack.
      */
    }
    else {


      }


    }
  
}
var template = document.getElementById("rtftemplate");
parse(template.innerHTML);
</script>
<div id="documentcontainer">


</div>
<button onclick="downloadRTF();">download</button>
